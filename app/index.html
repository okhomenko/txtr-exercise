<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Blloon bookshelf</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

    <link rel="stylesheet" href="css/blloon-styles.css">
    <link rel="stylesheet" href="css/app.css">
</head>
<body>

<div class="bln-container">

</div>

<script src="js/modules.js"></script>

<!-- Libs -->
<script src="js/lib/noop.js"></script>
<script src="js/lib/ajax.js"></script>
<script src="js/lib/compile.js"></script>

<!-- Components -->
<script src="js/components/store/StoreBlock.js"></script>
<script src="js/components/store/StoreBox.js"></script>
<script src="js/components/store/StoreSearchBox.js"></script>
<script src="js/components/Books.js"></script>
<script src="js/components/Book.js"></script>

<script src="js/app.js"></script>

<script>
    (function () {

    function compile(template) {
        var container, children;

        container = document.createElement('div');
        container.innerHTML = template;
        children = container.children;

        if (children.length > 1) throw new Error('Only one root node allowed');

        return children[0];
    }

    var ajax = BLN.ajax;

    var blnContainer,
        bookStore,
        storeBlock, searchBox, storeBox, bookTmpl,
        shelfBlock, dndPlaceholder, shelfBox;

    bookStore = compile(document.querySelector('#book-store').innerText);

    storeBlock = compile(document.querySelector('#book-block').innerText);
    bookTmpl = compile(document.querySelector('#book').innerText);
    searchBox = compile(document.querySelector('#search-box').innerText);
    storeBox = compile(document.querySelector('#store-box').innerText);

    shelfBlock = compile(document.querySelector('#shelf-block').innerText);
    dndPlaceholder = compile(document.querySelector('#dnd-placeholder').innerText);
    shelfBox = compile(document.querySelector('#shelf-box').innerText);


    blnContainer = document.querySelector('.bln-container');

    storeBlock.appendChild(searchBox);

    var staticBooks = [
        {author: 'Alex', title: 'Peace and War', 'img': '', id: 1},
        {author: 'Igod', title: 'Greatful dead', 'img': '', id: 2},
        {author: 'Dima', title: 'Pink Floyd', 'img': '', id: 3},
        {author: 'Lena', title: 'Google Analytics', 'img': '', id: 4}
    ];

    function noop() {}

    function renderBook(book) {
        var clone = bookTmpl.cloneNode(true);


    }

    function renderBooks(books, cb) {
        var container = document.createDocumentFragment();

        books.map(renderBook).forEach(function (el) {
            container.appendChild(el);
        });

        (cb || noop)(container);
    }

    function renderStoreBox(books) {
        renderBooks(books, function (els) {
            storeBox.innerHTML = '';
            storeBox.appendChild(els);
        });

    }

    function renderStoreBoxError(books) {
        console.log(books);
    }


    function refreshBooks(query) {
        var url, xhr;

        url = 'http://turbine-staging-eu.herokuapp.com/books';

        xhr = ajax({
            url: url + '?' + 'q=' + query,
            dataType: 'json',
            success: renderStoreBox,
            error: renderStoreBoxError
        });

        return xhr;
    }

    searchBox.addEventListener('keydown', function (e) {
        if (e.keyCode !== 13) return;

        var q = e.target.value.trim();
        if (q === '') return;

        refreshBooks(q);
        e.preventDefault();
    });

    storeBlock.appendChild(storeBox);

    storeBox.addEventListener('dragstart', function (e) {
        var _this = e.target;

        if ([].indexOf.call(_this.classList, 'book') === -1) return false;
        e.dataTransfer.setData('application/json', JSON.stringify(_this.model));

    }, false);

    bookStore.appendChild(storeBlock);

    shelfBlock.appendChild(dndPlaceholder);
    shelfBlock.appendChild(shelfBox);

    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault(); // allows us to drop
        return false;
    }

    function handleDrop(e) {
        var book = JSON.parse(e.dataTransfer.getData('application/json'));

        pushToShelf(book);
        return false;
    }

    function renderShelfBox(books) {
        renderBooks(books, function (els) {
            shelfBox.appendChild(els);
        });
    }

    var localBooks = JSON.parse(localStorage.getItem('shelf')) || [];
    function pushToShelf(book) {
        localBooks.push(book);
        renderShelfBox(localBooks);
    }

    shelfBox.addEventListener('drop', handleDrop);
    shelfBox.addEventListener('dragover', handleDragOver);

    bookStore.appendChild(shelfBlock);

    blnContainer.appendChild(bookStore);
    })


</script>

</body></html>
